<script>
        // --- 設定與參數 ---
        const DAILY_LIMIT = 30; // 每日單字量
        const REQUEST_RETENTION = 0.9; // 希望保留率 90% (FSRS 標準)
        
        // FSRS v5 預設參數 (W weights)
        // 這些權重是用數百萬條學習紀錄訓練出來的通用標準
        const w = [
            0.40255, 1.18385, 3.173, 15.69105, 
            7.19605, 0.5345, 1.4604, 0.0046, 
            1.54575, 0.1192, 1.01925, 1.9395, 
            0.11, 0.29605, 2.2707, 0.28855, 
            0.37605, 0.85485, 0.2464
        ];

        // 初始單字庫
        const defaultWords = [
            { id: 1, word: "Abate", phonetic: "/əˈbeɪt/", def: "v. 減輕；減少", examples: [{en: "The storm suddenly abated.", zh: "暴風雨突然減弱了。"}] },
            { id: 2, word: "Aberrant", phonetic: "/əˈber.ənt/", def: "adj. 異常的", examples: [{en: "Aberrant behavior.", zh: "異常行為。"}] },
            { id: 3, word: "Cacophony", phonetic: "/kəˈkɒf.ə.ni/", def: "n. 刺耳的聲音", examples: [{en: "A cacophony of bells.", zh: "刺耳的鐘聲。"}] },
            // ... 這裡可以繼續擴充您的單字
        ];

        let words = [];
        let sessionQueue = [];
        let sessionStats = { correct: 0, wrong: 0, total: 0, currentIndex: 0 };
        let currentWord = null;

        // --- FSRS 核心演算法 ---
        
        // 計算下次間隔天數 (Interval)
        function nextInterval(s) {
            // 公式：Interval = S * 9 * (1/R - 1)
            // 讓 R (可提取性) 降到 90% 所需的時間
            return Math.max(1, Math.round(s * 9 * (1/REQUEST_RETENTION - 1)));
        }

        // 初始學習 (First learning)
        function initFSRS(grade) {
            // grade: 1(Forgot), 2(Hard), 3(Good), 4(Easy)
            // 根據按鈕對應：忘記=1, 模糊=2(Hard), 秒殺=4(Easy) - 這裡我們簡化對應
            // 我們的按鈕: 忘記(1), 模糊(2->3 Good), 秒殺(3->4 Easy)
            let rating = 0;
            if(grade === 1) rating = 1;
            if(grade === 2) rating = 3; // 模糊通常對應 Good
            if(grade === 3) rating = 4; // 秒殺對應 Easy

            // 初始 S (Stability)
            const s = w[rating - 1]; 
            // 初始 D (Difficulty)
            const d = w[4] - (rating - 3) * w[5];
            
            return { s: s, d: d };
        }

        // 複習演算法 (Review updates)
        function nextFSRS(d, s, grade, daysSinceReview) {
            let rating = 0;
            if(grade === 1) rating = 1;
            if(grade === 2) rating = 3;
            if(grade === 3) rating = 4;

            // 1. 計算新的 Difficulty (D)
            // 限制 D 在 1 到 10 之間
            let nextD = d - w[6] * (rating - 3);
            nextD = w[5] * d + (1 - w[5]) * nextD;
            if (nextD < 1) nextD = 1;
            if (nextD > 10) nextD = 10;

            // 2. 計算新的 Stability (S)
            let nextS = s;
            if (rating === 1) {
                // 忘記了 (Again)
                nextS = w[11] * Math.pow(d, -w[12]) * (Math.pow(s + 1, w[13]) - 1) * Math.exp(w[14] * (1 - REQUEST_RETENTION));
            } else {
                // 記得 (Hard/Good/Easy)
                // FSRS v5 核心公式：S_new = S * (1 + factor)
                const hardPenalty = (rating === 2) ? w[15] : 1;
                const easyBonus = (rating === 4) ? w[16] : 1;
                
                // 計算 Retrievability (R)
                const r = Math.pow(1 + daysSinceReview / (9 * s), -1);

                nextS = s * (1 + Math.exp(w[8]) * (11 - d) * Math.pow(s, -w[9]) * (Math.exp((1 - r) * w[10]) - 1) * hardPenalty * easyBonus);
            }

            return { s: nextS, d: nextD };
        }

        // --- 應用程式邏輯 ---

        function init() {
            // 使用新 key v5
            const stored = localStorage.getItem('gre_vocab_v5_fsrs'); 
            if (stored) {
                words = JSON.parse(stored);
            } else {
                words = defaultWords.map(w => ({ 
                    ...w, 
                    nextReview: Date.now(), 
                    interval: 0, 
                    repetitions: 0,
                    // FSRS 專屬屬性
                    fsrs_s: 0, // Stability
                    fsrs_d: 0, // Difficulty
                    lastReviewDate: 0 
                }));
                saveData();
            }
            prepareSession();
            updateTotalCount();
        }

        function prepareSession() {
            const now = Date.now();
            // FSRS: 找出 nextReview 小於現在的
            const dueReview = words.filter(w => w.nextReview <= now && w.repetitions > 0);
            const newWords = words.filter(w => w.repetitions === 0);

            sessionQueue = [...dueReview];
            if (sessionQueue.length < DAILY_LIMIT) {
                const quotaLeft = DAILY_LIMIT - sessionQueue.length;
                sessionQueue = sessionQueue.concat(newWords.slice(0, quotaLeft));
            } else {
                sessionQueue = sessionQueue.slice(0, DAILY_LIMIT);
            }

            sessionStats = { total: sessionQueue.length, currentIndex: 0, correct: 0, wrong: 0 };
            updateHeader();

            if (sessionQueue.length > 0) {
                showNextCard();
            } else {
                showEmptyState();
            }
        }

        function updateHeader() {
            const progress = sessionStats.currentIndex;
            const total = sessionStats.total;
            const percent = total === 0 ? 0 : (progress / total) * 100;
            document.getElementById('progress-text').innerText = `${progress} / ${total}`;
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('session-score').innerText = `✓ ${sessionStats.correct}`;
        }

        function showNextCard() {
            if (sessionStats.currentIndex >= sessionStats.total) {
                showSummary();
                return;
            }
            currentWord = sessionQueue[sessionStats.currentIndex];
            document.getElementById('word-text').innerText = currentWord.word;
            document.getElementById('word-phonetic').innerText = currentWord.phonetic || "";
            document.getElementById('word-def').innerText = currentWord.def;

            const exContainer = document.getElementById('word-examples');
            exContainer.innerHTML = '';
            if (currentWord.examples) {
                currentWord.examples.forEach(ex => {
                    const div = document.createElement('div');
                    div.className = 'example-item';
                    div.innerHTML = `<div class="en-sent">${ex.en}</div><div class="zh-sent">${ex.zh}</div>`;
                    exContainer.appendChild(div);
                });
            }

            document.getElementById('word-def').style.display = 'none';
            document.getElementById('word-examples').style.display = 'none';
            document.getElementById('show-answer').style.display = 'block';
            document.getElementById('rating-btns').style.display = 'none';
            document.getElementById('card-view').style.display = 'flex';
            document.getElementById('summary-view').style.display = 'none';
        }

        function showAnswer() {
            document.getElementById('word-def').style.display = 'block';
            document.getElementById('word-examples').style.display = 'block';
            document.getElementById('show-answer').style.display = 'none';
            document.getElementById('rating-btns').style.display = 'flex';
        }

        function rateWord(grade) {
            // grade: 1(忘記), 2(模糊), 3(秒殺)
            const wordInDb = words.find(w => w.id === currentWord.id);
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;

            // 計算距離上次複習經過幾天
            let daysSinceReview = 0;
            if (wordInDb.lastReviewDate > 0) {
                daysSinceReview = (now - wordInDb.lastReviewDate) / oneDay;
            }

            // --- FSRS 運算區 ---
            let newStats;
            if (wordInDb.repetitions === 0) {
                // 第一次學習
                newStats = initFSRS(grade);
            } else {
                // 複習
                newStats = nextFSRS(wordInDb.fsrs_d, wordInDb.fsrs_s, grade, daysSinceReview);
            }

            // 更新數據
            wordInDb.fsrs_d = newStats.d;
            wordInDb.fsrs_s = newStats.s;
            wordInDb.interval = nextInterval(wordInDb.fsrs_s); // 將 S 轉換為天數
            wordInDb.nextReview = now + (wordInDb.interval * oneDay);
            wordInDb.lastReviewDate = now;

            // 統計
            if (grade === 1) {
                sessionStats.wrong++;
                // 忘記時，repetitions 不一定要歸零，但 FSRS 邏輯中 S 會大幅下降
                // 這裡我們只增加次數，讓 S 決定下次時間
                wordInDb.repetitions += 1; 
            } else {
                sessionStats.correct++;
                wordInDb.repetitions += 1;
            }

            sessionStats.currentIndex++;
            updateHeader();
            saveData();
            showNextCard();
        }

        function showSummary() {
            document.getElementById('card-view').style.display = 'none';
            document.getElementById('action-area').style.display = 'none';
            document.getElementById('summary-view').style.display = 'flex';
            const accuracy = Math.round((sessionStats.correct / sessionStats.total) * 100) || 0;
            document.getElementById('final-score').innerText = `${accuracy}%`;
        }

        function showEmptyState() {
            document.getElementById('card-view').style.display = 'none';
            document.getElementById('empty-view').classList.remove('hidden');
            document.getElementById('empty-view').style.display = 'flex';
            document.getElementById('action-area').style.display = 'none';
        }

        // --- 管理功能 (沿用) ---
        function openAdmin() {
            document.getElementById('admin-modal').style.display = 'flex';
            document.getElementById('data-area').value = JSON.stringify(words, null, 2);
            updateTotalCount();
        }
        function closeAdmin() { document.getElementById('admin-modal').style.display = 'none'; }
        function switchTab(tab) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            event.target.classList.add('active');
        }
        function addNewWord() {
            const w = document.getElementById('new-word').value.trim();
            const d = document.getElementById('new-def').value.trim();
            if (!w || !d) { alert('單字和定義是必填的！'); return; }
            const newObj = {
                id: Date.now(), word: w, phonetic: document.getElementById('new-phonetic').value.trim(), def: d, examples: [],
                nextReview: Date.now(), interval: 0, repetitions: 0,
                fsrs_s: 0, fsrs_d: 0, lastReviewDate: 0
            };
            const exEn = document.getElementById('new-ex-en').value.trim();
            const exZh = document.getElementById('new-ex-zh').value.trim();
            if (exEn) newObj.examples.push({ en: exEn, zh: exZh });
            words.push(newObj);
            saveData();
            document.getElementById('new-word').value = ''; document.getElementById('new-phonetic').value = ''; document.getElementById('new-def').value = ''; document.getElementById('new-ex-en').value = ''; document.getElementById('new-ex-zh').value = '';
            alert('單字已儲存！'); updateTotalCount();
        }
        function exportData() { navigator.clipboard.writeText(document.getElementById('data-area').value).then(() => alert('複製成功！')); }
        function importData() {
            try {
                const data = JSON.parse(document.getElementById('data-area').value);
                if (Array.isArray(data)) { if(confirm('確定覆蓋？')) { words = data; saveData(); location.reload(); } }
                else { alert('格式錯誤'); }
            } catch (e) { alert('JSON 錯誤'); }
        }
        function saveData() { localStorage.setItem('gre_vocab_v5_fsrs', JSON.stringify(words)); }
        function updateTotalCount() { document.getElementById('total-words-count').innerText = words.length; }
        function resetAll() { if(confirm('確定清空？')) { localStorage.removeItem('gre_vocab_v5_fsrs'); location.reload(); } }

        init();
    </script>
